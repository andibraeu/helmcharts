# Music Assistant Server Helm Chart

## Description

This Helm chart installs a Music Assistant Server in your Kubernetes cluster. Music Assistant is a powerful media server for integrating music streaming services and controlling devices in your home network.

The server always runs as a single replica to maintain proper state management.

## Installation

```bash
helm install music-assistant ./charts/music-assistant-server
```

## Configuration

### Basic Configuration

```yaml
deploymentStrategy:
  type: RollingUpdate  # Can be "Recreate" or "RollingUpdate"
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

image:
  repository: ghcr.io/music-assistant/server
  tag: latest
  pullPolicy: IfNotPresent

hostNetwork: false  # Set to true to enable network access at host level
```

### Service

```yaml
service:
  type: ClusterIP
  ports:
    web:
      port: 80
      targetPort: 8095
    devices:
      port: 8097
      targetPort: 8097
```

### Persistence

The Music Assistant Server data is stored in a persistent volume:

```yaml
persistence:
  enabled: true
  size: 10Gi
  mountPath: /data
  accessMode: ReadWriteOnce
  storageClass: ""  # Leave empty for the default StorageClass or specify your own
```

### OAuth2 Proxy

The chart offers the option to enable an OAuth2 proxy for authentication:

```yaml
oauth2Proxy:
  enabled: false  # Set to true to enable OAuth2 Proxy
  image:
    repository: quay.io/oauth2-proxy/oauth2-proxy
    tag: latest
    pullPolicy: IfNotPresent
  config:
    provider: oidc
    providerDisplayName: "Authentik"
    skipProviderButton: true
    passAuthorizationHeader: true
    setAuthorizationHeader: true
    oidcIssuerURL: "oidc-issuer-url"
    redirectURL: "redirect-url"
    sessionStoreType: cookie
    cookieRefresh: 119m
    clientID: ""
    clientSecret: ""
    cookieSecret: ""
  secretRef: ""  # Name of an existing Kubernetes Secret if secrets should be used
```

#### OAuth2 Secrets

You can either specify the OAuth2 configuration values directly in the values.yaml or create a Kubernetes Secret containing the following values:

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: oauth2-proxy-secrets
type: Opaque
data:
  client-id: <base64-encoded-client-id>
  client-secret: <base64-encoded-client-secret>
  cookie-secret: <base64-encoded-cookie-secret>
```

And then reference this Secret in your values.yaml:

```yaml
oauth2Proxy:
  secretRef: "oauth2-proxy-secrets"
```

### Ingress Configuration

When OAuth2 Proxy is enabled, an Ingress is automatically created:

```yaml
oauth2Proxy:
  ingress:
    hostname: music-assistant.local
    annotations: {}
      # kubernetes.io/ingress.class: nginx
      # kubernetes.io/tls-acme: "true"
      # external-dns.alpha.kubernetes.io/hostname: music-assistant.example.com
    tls:
      enabled: false
      secretName: music-assistant-tls
      # If secretName is not specified, a secret can be generated by cert-manager using appropriate annotations
      # cert-manager.io/cluster-issuer: letsencrypt
```

## Host Network

When you set `hostNetwork: true`, the container will run directly on the host network. This enables:

1. Direct access to ports from the host (8095 for Web UI, 8097 for device communication)
2. Enhanced network capabilities for detecting devices in the local network

Note, however, that this may have security implications and in multi-node clusters, the application will only be accessible on the specific node where the pod is running. 